.with-local-repo-bash:
  variables:
      GIT_STRATEGY: "none"
  before_script:
    - git init
    - git remote add local "$LOCAL_REPO_PATH"
    - git fetch --depth 500 local
    - git remote add origin "$CI_REPOSITORY_URL"
    - |
      if [ -z "${CI_COMMIT_BRANCH:-$CI_MERGE_REQUEST_SOURCE_BRANCH_NAME}" ]; then
          echo "No branch specified. Stopping the pipeline."
          exit 1
      fi
    - echo "Fetching from remote branch ${CI_COMMIT_BRANCH:-$CI_MERGE_REQUEST_SOURCE_BRANCH_NAME}"
    - |
      if ! git fetch origin "${CI_COMMIT_BRANCH:-$CI_MERGE_REQUEST_SOURCE_BRANCH_NAME}"; then
            echo -e "\e[31mFetching failed for branch ${CI_COMMIT_BRANCH:-$CI_MERGE_REQUEST_SOURCE_BRANCH_NAME} from $CI_REPOSITORY_URL.\e[0m"
            echo "Attempting to fetch the merge request branch, assuming this pipeline is not running in a fork."
            git fetch origin "merge-requests/${CI_MERGE_REQUEST_IID}/head"
      fi
    - git checkout FETCH_HEAD

.with-local-repo-pwsh:
  variables:
      GIT_STRATEGY: "none"
  before_script:
    - git init
    - git remote add local $env:LOCAL_REPO_PATH
    - git fetch --depth 500 local
    - git remote add origin $env:CI_REPOSITORY_URL
    - |
      $branchName = $env:CI_COMMIT_BRANCH
      if ([string]::IsNullOrEmpty($branchName)) {
          $branchName = $env:CI_MERGE_REQUEST_SOURCE_BRANCH_NAME
      }
      if ([string]::IsNullOrEmpty($branchName)) {
          Write-Output "No branch specified. Stopping the pipeline."
          exit 1
      }
    - Write-Output "Fetching from remote branch $branchName"
    - |
      if (! git fetch origin $branchName) {
        Write-Output "Fetching failed for branch $branchName from $env:CI_REPOSITORY_URL."
        Write-Output "Attempting to fetch the merge request branch, assuming this pipeline is not running in a fork."
        git fetch origin "merge-requests/$env:CI_MERGE_REQUEST_IID/head"
      }
    - git checkout FETCH_HEAD
